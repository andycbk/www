<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ‰‹å‹¢æ§åˆ¶é«˜è§£æåœ°çƒå„€</title>
    
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.111/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.111/Build/Cesium/Cesium.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <style>
        body { margin: 0; overflow: hidden; background-color: #000; }
        /* Cesium å®¹å™¨ */
        #cesiumContainer { width: 100%; height: 100vh; margin: 0; padding: 0; overflow: hidden; }
        
        /* éš±è— Cesium çš„ä¸€äº›æµ®æ°´å°å’ŒæŒ‰éˆ•ï¼Œè®“ç•«é¢æ›´ä¹¾æ·¨ */
        .cesium-viewer-bottom, .cesium-viewer-animationContainer, .cesium-viewer-timelineContainer {
            display: none !important;
        }

        /* æ”å½±æ©Ÿé è¦½ */
        .video-layer {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 100px;
            height: 133px;
            z-index: 10;
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 8px;
            overflow: hidden;
            transform: scaleX(-1); /* é¡åƒ */
            opacity: 0.8;
        }
        #input_video { width: 100%; height: 100%; object-fit: cover; }

        /* ç‹€æ…‹æç¤º */
        #status-box {
            position: absolute;
            top: 10px; left: 10px;
            background: rgba(42, 42, 42, 0.8);
            color: #fff;
            padding: 15px;
            border-radius: 8px;
            font-family: sans-serif;
            z-index: 100;
            pointer-events: none;
            max-width: 300px;
        }
        #status-box h2 { margin: 0 0 10px 0; font-size: 18px; color: #4db8ff;}
        #status-box p { margin: 5px 0; font-size: 14px; }
        .highlight { color: #ffcc00; font-weight: bold; }

        /* æ‰‹æŒ‡æ¸¸æ¨™ */
        #cursor {
            position: absolute;
            width: 30px; height: 30px;
            background: rgba(255, 50, 50, 0.6);
            border: 3px solid rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            z-index: 90;
            display: none; /* é è¨­éš±è— */
            transform: translate(-50%, -50%);
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="cesiumContainer"></div>

    <div id="status-box">
        <h2>æ‰‹å‹¢æ§åˆ¶æŒ‡å—</h2>
        <p id="loading-status" style="color:red;">æ­£åœ¨å•Ÿå‹•æ”å½±æ©Ÿï¼Œè«‹ç¨å€™...</p>
        <p>ğŸ–ï¸ <b>å–®æŒ‡ç§»å‹•ï¼š</b> æ—‹è½‰åœ°çƒ</p>
        <p>ğŸ¤ <b>å…©æŒ‡æåˆï¼š</b> æ”¾å¤§/ç¸®å° (çœ‹è¡—é“)</p>
    </div>

    <div id="cursor"></div>

    <div class="video-layer">
        <video id="input_video" playsinline></video>
    </div>

    <script>
        // --- 1. CesiumJS åœ°çƒå„€è¨­å®š ---
        // é€™è£¡ä½¿ç”¨ Cesium é è¨­çš„ Bing Maps å½±åƒï¼Œç„¡éœ€ API Key å³å¯é¡¯ç¤ºè©³ç´°è¡—é“
        const viewer = new Cesium.Viewer('cesiumContainer', {
            imageryProvider : new Cesium.IonImageryProvider({ assetId: 2 }), // ä½¿ç”¨é è¨­é«˜è§£æè¡›æ˜Ÿåœ–
            terrainProvider: Cesium.createWorldTerrain(), // åŠ å…¥åœ°å½¢èµ·ä¼
            baseLayerPicker : false, // éš±è—åœ–å±¤é¸æ“‡å™¨
            geocoder : false, // éš±è—æœå°‹æ¡†
            animation : false, // éš±è—å‹•ç•«æ§åˆ¶
            timeline : false, // éš±è—æ™‚é–“è»¸
            sceneModePicker : false, // éš±è—æ¨¡å¼é¸æ“‡
            navigationHelpButton : false, // éš±è—å¹«åŠ©æŒ‰éˆ•
            homeButton: false, // éš±è—å›åˆ°åŸé»æŒ‰éˆ•
            infoBox: false,
            selectionIndicator: false,
            fullscreenButton: false
        });

        // ç§»é™¤é è¨­çš„æ»‘é¼ æ“ä½œï¼Œé¿å…è¡çª (å¯é¸)
        // viewer.scene.screenSpaceCameraController.enableRotate = false;
        // viewer.scene.screenSpaceCameraController.enableZoom = false;

        const scene = viewer.scene;
        const camera = viewer.camera;
        
        // è¨­å®šåˆå§‹è¦–è§’
        camera.setView({
            destination : Cesium.Cartesian3.fromDegrees(121.5, 23.5, 10000000.0) // å°ç£ä¸Šæ–¹ä¸€åƒè¬å…¬å°º
        });

        // --- 2. MediaPipe æ‰‹å‹¢è®Šæ•¸ ---
        let previousX = null;
        let previousY = null;
        let previousPinchDistance = null;
        const cursor = document.getElementById('cursor');
        const loadingStatus = document.getElementById('loading-status');

        // è¨ˆç®—å…©é»è·é›¢çš„è¼”åŠ©å‡½å¼ (ç”¨æ–¼æåˆ)
        function getDistance(p1, p2) {
            return Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2));
        }

        function onResults(results) {
            loadingStatus.style.display = "none"; // éš±è—è¼‰å…¥æ–‡å­—

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                cursor.style.display = "block";
                
                // å–å¾—ç¬¬ä¸€éš»æ‰‹
                const landmarks = results.multiHandLandmarks[0];
                
                // å–å¾—é—œéµé»ï¼šæ‹‡æŒ‡å°–(4) å’Œ é£ŸæŒ‡å°–(8)
                const thumbTip = landmarks[4];
                const indexTip = landmarks[8];

                // --- è™•ç†æ¸¸æ¨™é¡¯ç¤º (ä½¿ç”¨é£ŸæŒ‡ä½ç½®) ---
                // é¡åƒç¿»è½‰ X è»¸
                const currentX = 1.0 - indexTip.x;
                const currentY = indexTip.y;
                cursor.style.left = (currentX * 100) + "%";
                cursor.style.top = (currentY * 100) + "%";

                // --- è™•ç†æ—‹è½‰ (åŸºæ–¼é£ŸæŒ‡ç§»å‹•é‡) ---
                if (previousX !== null && previousY !== null) {
                    // è¨ˆç®—èˆ‡ä¸Šä¸€å¹€çš„ä½ç§»å·® (Delta)
                    const deltaX = currentX - previousX;
                    const deltaY = currentY - previousY;

                    // éˆæ•åº¦è¨­å®š
                    const rotateSpeed = 3.0;

                    // ä½¿ç”¨ Cesium çš„ç›¸æ©Ÿæ—‹è½‰åŠŸèƒ½
                    // å·¦å³ç§»å‹• -> ç¹è‘—ä¸­å¿ƒé»æ—‹è½‰
                    camera.rotateRight(deltaX * rotateSpeed);
                    // ä¸Šä¸‹ç§»å‹• -> ç¹è‘—ä¸­å¿ƒé»ä¸Šä¸‹å‚¾æ–œ
                    camera.rotateUp(deltaY * rotateSpeed);
                }
                
                // æ›´æ–°ä¸Šä¸€å¹€çš„ä½ç½®è¨˜éŒ„
                previousX = currentX;
                previousY = currentY;

                // --- è™•ç†ç¸®æ”¾ (æåˆæ‰‹å‹¢) ---
                // è¨ˆç®—æ‹‡æŒ‡èˆ‡é£ŸæŒ‡çš„è·é›¢
                const currentPinchDistance = getDistance(thumbTip, indexTip);

                if (previousPinchDistance !== null) {
                    // è¨ˆç®—è·é›¢è®ŠåŒ–é‡
                    const pinchDelta = currentPinchDistance - previousPinchDistance;
                    
                    // è¨­å®šç¸®æ”¾éˆæ•åº¦ (æ ¹æ“šç›®å‰é«˜åº¦å‹•æ…‹èª¿æ•´æœƒæ›´å¥½ï¼Œé€™è£¡å…ˆç”¨å›ºå®šå€¼)
                    // é«˜åº¦è¶Šé«˜ï¼Œç¸®æ”¾æ­¥è·è¶Šå¤§
                    const height = camera.positionCartographic.height;
                    let zoomFactor = height * 0.05; 

                    // è¨­å®šä¸€å€‹æœ€å°ç¸®æ”¾æ­¥è·ï¼Œé¿å…åœ¨åœ°é¢é™„è¿‘å¡ä½
                    if (zoomFactor < 100) zoomFactor = 100;

                    // 0.01 æ˜¯ä¸€å€‹é–¥å€¼ï¼Œé¿å…æ‰‹æŠ–å‹•é€ æˆå¾®å¹…ç¸®æ”¾
                    if (Math.abs(pinchDelta) > 0.01) {
                         if (pinchDelta > 0) {
                            // è·é›¢è®Šå¤§ -> å…©æŒ‡å¼µé–‹ -> æ”¾å¤§ (Zoom In)
                             camera.zoomIn(pinchDelta * zoomFactor);
                         } else {
                            // è·é›¢è®Šå° -> å…©æŒ‡æåˆ -> ç¸®å° (Zoom Out)
                             camera.zoomOut(Math.abs(pinchDelta) * zoomFactor);
                         }
                    }
                }
                // æ›´æ–°ä¸Šä¸€å¹€çš„æåˆè·é›¢
                previousPinchDistance = currentPinchDistance;

            } else {
                // æ²’æœ‰åµæ¸¬åˆ°æ‰‹æ™‚ï¼Œé‡ç½®è®Šæ•¸
                cursor.style.display = "none";
                previousX = null;
                previousY = null;
                previousPinchDistance = null;
            }
        }

        // --- 3. åˆå§‹åŒ– MediaPipe ---
        const videoElement = document.getElementById('input_video');
        const hands = new Hands({locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
        }});

        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 1,
            minDetectionConfidence: 0.6, // æé«˜ä¸€é»ä¿¡å¿ƒåº¦é–€æª»
            minTrackingConfidence: 0.6
        });

        hands.onResults(onResults);

        const cameraUtils = new Camera(videoElement, {
            onFrame: async () => {
                await hands.send({image: videoElement});
            },
            width: 640, // ä½¿ç”¨ç¨é«˜çš„è§£æåº¦ä»¥ç²å¾—æ›´å¥½çš„æ‰‹å‹¢ç²¾åº¦
            height: 480,
            facingMode: 'user'
        });
        
        cameraUtils.start()
            .catch(err => {
                console.error(err);
                loadingStatus.innerText = "éŒ¯èª¤ï¼šç„¡æ³•å•Ÿå‹•æ”å½±æ©Ÿã€‚è«‹ç¢ºä¿ä½¿ç”¨ HTTPS æˆ– localhostã€‚";
                alert("ç„¡æ³•å•Ÿå‹•æ”å½±æ©Ÿï¼Œè«‹æª¢æŸ¥æ¬Šé™æˆ–æ˜¯å¦ä½¿ç”¨ HTTPS é€£ç·šã€‚");
            });

    </script>
</body>
</html>
